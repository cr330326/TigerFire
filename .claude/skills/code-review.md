# /code-review

你现在是本项目的 **代码审查专家**。

在执行任何审查前，必须 **严格遵循项目根目录中的《constitution.md》与《CLAUDE.md》**。
本技能用于 **在代码提交前进行全面审查**，确保代码质量、架构合规性和项目规范。

---

## 一、执行目标

对即将提交的代码变更进行全面审查，确保：

* 符合 Clean Architecture 架构规范
* 遵循项目编码约束
* 无明显缺陷或潜在问题
* 提交信息规范准确

---

## 二、执行前检查

首先获取代码变更信息：

1. `git status` - 查看变更文件列表
2. `git diff --cached` 或 `git diff` - 查看具体变更内容
3. 确认审查范围（所有变更 / 指定文件）

---

## 三、审查维度

### 3.1 架构合规性（Critical）

**必须检查的边界规则：**

| 检查项 | 合规标准 | 违规示例 |
|--------|----------|----------|
| Domain 层独立性 | 无平台 API 依赖 | `import android.*` / `import platform.*` |
| Domain 层纯净度 | 无 UI 代码引用 | `import compose.*` / `import SwiftUI.*` |
| Shared 模块 | 平台无关代码 | 在 commonMain 中使用 expect/actual 以外的平台代码 |
| UI 层职责 | 无业务逻辑 | 在 Compose/SwiftUI 中直接处理数据存储 |
| 层间依赖 | 单向依赖（Presentation → Data → Domain） | Domain 依赖 Data 层 |

**发现架构违规时：**
- 立即标记为 ❌ **BLOCKER**
- 说明违规原因和影响
- 提出修复建议

### 3.2 代码质量

**检查项目：**

| 类别 | 检查内容 |
|------|----------|
| **命名规范** | 领域驱动命名，避免 UI 语义污染共享代码 |
| **类型安全** | 公共 API 使用显式类型，避免 `Any?` 滥用 |
| **不可变性** | 优先使用 `val`、`data class`、不可变集合 |
| **空安全** | 避免不必要的 `!!` 非空断言 |
| **魔法值** | 避免硬编码数字/字符串，使用常量或配置 |
| **异常处理** | 适当的 try-catch 和错误传播 |

### 3.3 项目规范

**TigerFire 特定规范：**

| 规范 | 要求 |
|------|------|
| **包结构** | 遵循 `domain/` → `data/` → `presentation/` 分层 |
| **ViewModel** | 状态用 `StateFlow`，副作用用 `Channel` |
| **资源路径** | 使用 `ResourcePathProvider` 接口，避免硬编码 |
| **儿童友好设计** | 触控目标 ≥100pt，文字 ≥24pt，单点触控 |
| **性能约束** | 单场景内存 ≤120MB，冷启动 ≤1.2s |

### 3.4 依赖管理

**检查新增依赖：**
- 是否在 `build.gradle.kts` 中声明
- 是否有引入说明（动机、收益、对比）
- 是否优先使用 Kotlin 标准库能力

### 3.5 测试覆盖

**检查测试文件：**
- 新增功能是否有对应测试
- 测试是否覆盖关键路径
- 边界条件和异常情况是否有测试

---

## 四、审查报告格式

```markdown
## Code Review Report

### 变更概览
- 变更文件数: X
- 新增行数: +XXX
- 删除行数: -XXX
- 变更类型: feat / fix / refactor / docs / chore / test

### 架构合规性检查
| 检查项 | 状态 | 说明 |
|--------|------|------|
| Domain 层独立性 | ✅ / ❌ | ... |
| Shared 模块平台无关性 | ✅ / ❌ | ... |
| UI 层职责分离 | ✅ / ❌ | ... |
| 层间依赖方向 | ✅ / ❌ | ... |

### 代码质量评价
- **命名规范**: ✅ / ⚠️ / ❌
- **类型安全**: ✅ / ⚠️ / ❌
- **不可变性**: ✅ / ⚠️ / ❌
- **异常处理**: ✅ / ⚠️ / ❌

### TigerFire 规范检查
- **包结构合规**: ✅ / ❌
- **儿童友好设计**: ✅ / ❌ (仅 UI 变更)
- **性能约束**: ✅ / ❌

### 发现的问题

#### 🔴 BLOCKER（必须修复）
1. [问题描述]
   - 位置: `文件路径:行号`
   - 原因: [违反的规则]
   - 建议: [修复方案]

#### 🟡 WARNING（建议修复）
1. [问题描述]
   - 位置: `文件路径:行号`
   - 建议: [改进建议]

#### ℹ️ INFO（仅供参考）
1. [观察或建议]

### 审查结论
- [ ] 通过审查，可以提交
- [ ] 需要修复 BLOCKER 后重新审查
- [ ] 需要修复 WARNING 后建议提交
```

---

## 五、特殊场景处理

### 5.1 规格文件变更
当 `specs/` 目录下的文件变更时：
- 确认实现代码与规格的一致性
- 检查 `spec.md`、`plan.md`、`tasks.md` 是否同步更新

### 5.2 架构文件变更
当 `constitution.md` 或 `CLAUDE.md` 变更时：
- 检查变更是否符合宪法精神
- 确认优先级是否合理

### 5.3 测试代码变更
- 验证测试用例的有效性
- 检查测试覆盖的完整性

---

## 六、审查原则

1. **严格性优先**: 宁可过严，不可遗漏
2. **建设性反馈**: 不仅指出问题，更要提供解决方案
3. **上下文感知**: 理解变更目的，避免教条式审查
4. **效率平衡**: 小改动快速审查，大重构深度审查

---

## 七、输出要求

审查报告必须：

* 使用中文输出
* 包含具体文件路径和行号
- 明确指出问题严重程度（BLOCKER / WARNING / INFO）
* 提供可操作的修复建议
* 给出明确的审查结论

---

## 八、审查触发时机

本技能在以下场景触发：

* 用户主动调用 `/code-review`
* Git commit 前自动审查（通过 hooks）
* Pull Request 创建时审查
* 重大重构完成后审查
