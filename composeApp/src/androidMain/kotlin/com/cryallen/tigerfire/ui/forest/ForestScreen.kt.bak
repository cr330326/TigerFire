package com.cryallen.tigerfire.ui.forest

import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.core.Animatable
import androidx.compose.animation.core.AnimationSpec
import androidx.compose.animation.core.FastOutSlowInEasing
import androidx.compose.animation.core.animateFloat
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.animation.core.infiniteRepeatable
import androidx.compose.animation.core.rememberInfiniteTransition
import androidx.compose.animation.core.spring
import androidx.compose.animation.core.LinearEasing
import androidx.compose.animation.core.tween
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.animation.scaleIn
import androidx.compose.animation.scaleOut
import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.BoxWithConstraints
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectDragGestures
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.offset
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.IconButton
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.alpha
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.draw.scale
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.center
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.drawscope.Stroke
import androidx.compose.ui.graphics.nativeCanvas
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalDensity
import com.cryallen.tigerfire.component.VideoPlayer
import com.cryallen.tigerfire.component.getAudioManager
import com.cryallen.tigerfire.presentation.forest.ForestEffect
import com.cryallen.tigerfire.presentation.forest.ForestEvent
import com.cryallen.tigerfire.presentation.forest.ForestViewModel
import kotlin.math.roundToInt
import kotlin.math.sin

/**
 * æ£®æž—åœºæ™¯ Screen
 *
 * æ‰‹åŠ¿æ‹–æ‹½æ•‘æ´åœºæ™¯ï¼šæ‹–æ‹½ç›´å‡æœºé è¿‘å°ç¾Šï¼Œæ”¾ä¸‹æ¢¯å­æ•‘æ´
 * æ•‘æ´å®ŒæˆåŽæ’­æ”¾åŠ¨ç”»å¹¶èŽ·å¾—å¾½ç« 
 *
 * @param viewModel ForestViewModel
 * @param onNavigateBack è¿”å›žä¸»åœ°å›¾å›žè°ƒ
 */
@Composable
fun ForestScreen(
    viewModel: ForestViewModel,
    onNavigateBack: () -> Unit = {}
) {
    val state by viewModel.state.collectAsState()
    val context = LocalContext.current
    val audioManager = remember { context.getAudioManager() }

    // è®¢é˜…å‰¯ä½œç”¨ï¼ˆEffectï¼‰
    LaunchedEffect(Unit) {
        viewModel.effect.collect { effect ->
            when (effect) {
                is ForestEffect.PlayRescueVideo -> {
                    // è§†é¢‘æ’­æ”¾ç”±çŠ¶æ€é©±åŠ¨ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
                }
                is ForestEffect.ShowBadgeAnimation -> {
                    // å¾½ç« åŠ¨ç”»åœ¨ showBadgeAnimation çŠ¶æ€ä¸­å¤„ç†
                }
                is ForestEffect.ShowCompletionHint -> {
                    // å®Œæˆæç¤ºç”±çŠ¶æ€é©±åŠ¨
                }
                is ForestEffect.PlayClickSound -> {
                    audioManager.playClickSound(com.cryallen.tigerfire.domain.model.SceneType.FOREST)
                }
                is ForestEffect.PlayDragSound -> {
                    audioManager.playDragSound()
                }
                is ForestEffect.PlaySnapSound -> {
                    audioManager.playSnapSound()
                }
                is ForestEffect.PlayBadgeSound -> {
                    audioManager.playBadgeSound()
                }
                is ForestEffect.PlayAllCompletedSound -> {
                    audioManager.playAllCompletedSound()
                }
                is ForestEffect.NavigateToMap -> onNavigateBack()
                is ForestEffect.PlaySlowDownVoice -> {
                    // æ’­æ”¾"æ…¢ä¸€ç‚¹"è¯­éŸ³æç¤º
                    // TODO: æ·»åŠ è¯­éŸ³èµ„æºæ–‡ä»¶å¹¶å–æ¶ˆæ³¨é‡Š
                    // audioManager.playVoice("voice/slow_down.mp3")
                }
                is ForestEffect.ShowIdleHint -> {
                    // æ˜¾ç¤ºç©ºé—²æç¤ºï¼šå°ç«"éœ€è¦å¸®å¿™å—ï¼Ÿ"
                    // TODO: å®žçŽ° UI æç¤ºæ˜¾ç¤ºé€»è¾‘
                }
                is ForestEffect.PlayStartVoice -> {
                    // æ’­æ”¾å¼€å§‹è¯­éŸ³ï¼š"å°ç¾Šè¢«å›°å•¦ï¼å¿«å¼€ç›´å‡æœºæ•‘å®ƒä»¬ï¼"
                    audioManager.playVoice("audio/voices/forest_start.mp3")
                }
                is ForestEffect.PlayCompleteVoice -> {
                    // æ’­æ”¾å®Œæˆè¯­éŸ³ï¼š"ç›´å‡æœºèƒ½ä»Žå¤©ä¸Šæ•‘äººï¼ŒçœŸåŽ‰å®³ï¼"
                    audioManager.playVoice("audio/voices/forest_complete.mp3")
                }
            }
        }
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
    ) {
        // æ£®æž—ç«ç¾åŠ¨ç”»èƒŒæ™¯
        ForestFireBackground()

        // æ¸¸æˆåŒºåŸŸï¼ˆå°ç¾Šå’Œç›´å‡æœºï¼‰- å…¨å±æ˜¾ç¤º
        ForestGameArea(
            state = state,
            onDragStarted = { viewModel.onEvent(ForestEvent.DragStarted) },
            onDragUpdated = { x, y ->
                viewModel.onEvent(ForestEvent.DragUpdated(x, y))
            },
            onDragEnded = { viewModel.onEvent(ForestEvent.DragEnded) },
            onLowerLadderClick = { sheepIndex ->
                viewModel.onEvent(ForestEvent.LowerLadderClicked(sheepIndex))
            }
        )

        // é¡¶éƒ¨ä¿¡æ¯æ ï¼ˆç»å¯¹å®šä½ï¼‰
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .align(Alignment.TopCenter)
                .padding(16.dp)
        ) {
            // è¿”å›žæŒ‰é’®ï¼ˆå·¦ä¸Šè§’ï¼‰
            Box(
                modifier = Modifier
                    .fillMaxWidth()
            ) {
                IconButton(
                    onClick = {
                        viewModel.onEvent(ForestEvent.BackToMapClicked)
                    },
                    modifier = Modifier
                        .size(48.dp)
                        .shadow(4.dp, CircleShape)
                        .background(Color.White, CircleShape)
                        .align(Alignment.CenterStart)
                ) {
                    Text(
                        text = "â†",
                        fontSize = 24.sp,
                        color = Color.Black
                    )
                }

                // åœºæ™¯æ ‡é¢˜ï¼ˆä¸­å¤®ï¼‰
                Text(
                    text = "æ£®æž—",
                    fontSize = 36.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color.White,
                    modifier = Modifier.align(Alignment.Center)
                )
            }

            Spacer(modifier = Modifier.height(8.dp))

            // æç¤ºæ–‡å­—
            Text(
                text = "æ‹–æ‹½ç›´å‡æœºåŽ»æ•‘å°ç¾Šï¼",
                fontSize = 18.sp,
                color = Color.White.copy(alpha = 0.9f),
                modifier = Modifier.align(Alignment.CenterHorizontally)
            )

            Spacer(modifier = Modifier.height(8.dp))

            // è¿›åº¦æ˜¾ç¤º
            Text(
                text = "å·²æ•‘æ´: ${state.rescuedSheep.size}/2",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White,
                modifier = Modifier.align(Alignment.CenterHorizontally)
            )

            // å…¨éƒ¨å®Œæˆæç¤º
            if (state.isAllCompleted) {
                Spacer(modifier = Modifier.height(8.dp))
                Text(
                    text = "ðŸŽ‰ å…¨éƒ¨å®Œæˆï¼",
                    fontSize = 18.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color.Yellow,
                    modifier = Modifier.align(Alignment.CenterHorizontally)
                )
            }
        }

        // æ•‘æ´è§†é¢‘æ’­æ”¾è¦†ç›–å±‚
        if (state.isPlayingRescueVideo && state.currentPlayingSheepIndex != null) {
            RescueVideoOverlay(
                sheepIndex = state.currentPlayingSheepIndex!!,
                onPlaybackComplete = { sheepIndex ->
                    viewModel.onEvent(ForestEvent.RescueVideoCompleted(sheepIndex))
                }
            )
        }

        // å¾½ç« æ”¶é›†åŠ¨ç”»è¦†ç›–å±‚
        BadgeAnimationOverlay(
            show = state.showBadgeAnimation,
            sheepIndex = state.earnedBadgeSheepIndex,
            onAnimationComplete = {
                viewModel.onEvent(ForestEvent.BadgeAnimationCompleted)
            }
        )
    }
}

/**
 * æ£®æž—æ¸¸æˆåŒºåŸŸ
 *
 * åŒ…å«å°ç¾Šã€ç›´å‡æœºå’Œæ”¾ä¸‹æ¢¯å­æŒ‰é’®
 */
@Composable
private fun ForestGameArea(
    state: com.cryallen.tigerfire.presentation.forest.ForestState,
    onDragStarted: () -> Unit,
    onDragUpdated: (Float, Float) -> Unit,
    onDragEnded: () -> Unit,
    onLowerLadderClick: (Int) -> Unit
) {
    // ä½¿ç”¨ BoxWithConstraints èŽ·å–å®žé™…å±å¹•å°ºå¯¸
    BoxWithConstraints(
        modifier = Modifier
            .fillMaxSize()
    ) {
        val containerWidthPx = constraints.maxWidth.toFloat()
        val containerHeightPx = constraints.maxHeight.toFloat()

        // å°ç¾Šä½ç½®ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
        val sheepPositions = listOf(
            0.65f to 0.35f,  // å°ç¾Š 1 - å³ä¸Š
            0.75f to 0.65f   // å°ç¾Š 2 - å³ä¸‹
        )

        // ç»˜åˆ¶å°ç¾Š
        sheepPositions.forEachIndexed { index, (xRatio, yRatio) ->
            val isRescued = index in state.rescuedSheep
            val isNearby = state.nearbySheepIndex == index

            SimpleSheep(
                xRatio = xRatio,
                yRatio = yRatio,
                isRescued = isRescued,
                isNearby = isNearby,
                screenWidth = containerWidthPx,
                screenHeight = containerHeightPx
            )
        }

        // ç›´å‡æœºï¼ˆå¯æ‹–æ‹½ï¼‰
        SimpleHelicopter(
            xRatio = state.helicopterX,
            yRatio = state.helicopterY,
            isDragging = state.isDraggingHelicopter,
            screenWidth = containerWidthPx,
            screenHeight = containerHeightPx,
            onDragStarted = onDragStarted,
            onDragUpdated = onDragUpdated,
            onDragEnded = onDragEnded
        )

        // "æ”¾ä¸‹æ¢¯å­"æŒ‰é’®ï¼ˆå½“é è¿‘å°ç¾Šæ—¶æ˜¾ç¤ºï¼‰
        if (state.showLowerLadderButton && state.nearbySheepIndex != null) {
            val sheepIndex = state.nearbySheepIndex
            SimpleLadderButton(
                xRatio = state.helicopterX,
                yRatio = state.helicopterY,
                screenWidth = containerWidthPx,
                screenHeight = containerHeightPx,
                onClick = { onLowerLadderClick(sheepIndex) }
            )
        }
    }
}

/**
 * ç®€åŒ–çš„ç›´å‡æœºç»„ä»¶
 */
@Composable
private fun SimpleHelicopter(
    xRatio: Float,
    yRatio: Float,
    isDragging: Boolean,
    screenWidth: Float,
    screenHeight: Float,
    onDragStarted: () -> Unit,
    onDragUpdated: (Float, Float) -> Unit,
    onDragEnded: () -> Unit
) {
    var currentPosition by remember { mutableStateOf(Offset.Zero) }

    // è®¡ç®—å±å¹•ä½ç½®ï¼ˆåƒç´ ï¼‰
    val xPosPx = (xRatio * screenWidth) - 75f
    val yPosPx = (yRatio * screenHeight) - 75f

    // æ‚¬æµ®åŠ¨ç”»
    val hoverOffset by rememberInfiniteTransition(label = "hover").animateFloat(
        initialValue = 0f,
        targetValue = -10f,
        animationSpec = infiniteRepeatable(
            animation = tween(1500, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "hover_offset"
    )

    // èžºæ—‹æ¡¨æ—‹è½¬åŠ¨ç”»
    val propellerRotation by rememberInfiniteTransition(label = "propeller").animateFloat(
        initialValue = 0f,
        targetValue = 360f,
        animationSpec = infiniteRepeatable(
            animation = tween(300, easing = LinearEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Restart
        ),
        label = "propeller_rotation"
    )

    Box(
        modifier = Modifier
            .offset {
                androidx.compose.ui.unit.IntOffset(
                    x = (xPosPx + currentPosition.x).toInt(),
                    y = (yPosPx + currentPosition.y + hoverOffset).toInt()
                )
            }
            .size(150.dp)
            .pointerInput(Unit) {
                detectDragGestures(
                    onDragStart = { onDragStarted() },
                    onDrag = { change, _ ->
                        change.consume()
                        val offsetX = (change.position.x - change.previousPosition.x) * 0.6f
                        val offsetY = (change.position.y - change.previousPosition.y) * 0.6f
                        currentPosition += Offset(offsetX, offsetY)

                        val newXRatio = (xPosPx + offsetX + 75f) / screenWidth
                        val newYRatio = (yPosPx + offsetY + 75f) / screenHeight
                        onDragUpdated(newXRatio, newYRatio)
                    },
                    onDragEnd = {
                        currentPosition = Offset.Zero
                        onDragEnded()
                    }
                )
            }
            .shadow(
                elevation = if (isDragging) 20.dp else 12.dp,
                shape = RoundedCornerShape(16.dp),
                spotColor = Color(0xFFF4A261),
                ambientColor = Color(0xFFF4A261)
            )
            .clip(RoundedCornerShape(16.dp))
            .background(Color(0xFF87CEEB).copy(alpha = if (isDragging) 0.95f else 0.85f)),
        contentAlignment = Alignment.Center
    ) {
        // ä½¿ç”¨æ–‡æœ¬ä½œä¸ºç›´å‡æœºå›¾æ ‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
        Text(
            text = "ðŸš",
            fontSize = 80.sp,
            modifier = Modifier
                .graphicsLayer {
                    rotationZ = propellerRotation * 0.1f // è½»å¾®æ—‹è½¬æ¨¡æ‹Ÿé£žè¡Œ
                }
        )
    }
}

/**
 * ç®€åŒ–çš„å°ç¾Šç»„ä»¶
 */
@Composable
private fun SimpleSheep(
    xRatio: Float,
    yRatio: Float,
    isRescued: Boolean,
    isNearby: Boolean,
    screenWidth: Float,
    screenHeight: Float
) {
    val scale by animateFloatAsState(
        targetValue = if (isNearby) 1.3f else 1f,
        animationSpec = spring(),
        label = "sheep_scale"
    )

    // è®¡ç®—å±å¹•ä½ç½®ï¼ˆåƒç´ ï¼‰
    val xPosPx = (xRatio * screenWidth) - 40f
    val yPosPx = (yRatio * screenHeight) - 40f

    // å‘¼å¸åŠ¨ç”»
    val breatheOffset by rememberInfiniteTransition(label = "breathe").animateFloat(
        initialValue = 0f,
        targetValue = 5f,
        animationSpec = infiniteRepeatable(
            animation = tween(1000, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "breathe_offset"
    )

    val finalYPos = if (!isRescued) yPosPx + breatheOffset else yPosPx

    Box(
        modifier = Modifier
            .offset {
                androidx.compose.ui.unit.IntOffset(
                    x = xPosPx.toInt(),
                    y = finalYPos.toInt()
                )
            }
            .size(80.dp)
            .scale(scale)
    ) {
        Text(
            text = "ðŸ‘",
            fontSize = 60.sp,
            color = if (isRescued) Color.Gray.copy(alpha = 0.5f) else Color.White,
            modifier = Modifier
                .shadow(
                    elevation = if (isNearby) 16.dp else 4.dp,
                    shape = CircleShape,
                    ambientColor = if (isNearby) Color.Yellow else Color.Transparent
                )
        )
    }
}

/**
 * ç®€åŒ–çš„æ¢¯å­æŒ‰é’®ç»„ä»¶
 */
@Composable
private fun SimpleLadderButton(
    xRatio: Float,
    yRatio: Float,
    screenWidth: Float,
    screenHeight: Float,
    onClick: () -> Unit
) {
    val pulseScale by rememberInfiniteTransition(label = "pulse").animateFloat(
        initialValue = 1f,
        targetValue = 1.1f,
        animationSpec = infiniteRepeatable(
            animation = tween(800, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "pulse_scale"
    )

    // è®¡ç®—å±å¹•ä½ç½®ï¼ˆåƒç´ ï¼‰
    val xPosPx = (xRatio * screenWidth) - 55f
    val yPosPx = (yRatio * screenHeight) + 80f

    Box(
        modifier = Modifier
            .offset {
                androidx.compose.ui.unit.IntOffset(
                    x = xPosPx.toInt(),
                    y = yPosPx.toInt()
                )
            }
            .size(110.dp)
            .scale(pulseScale)
            .shadow(
                elevation = 12.dp,
                shape = CircleShape,
                spotColor = Color(0xFFF4A261),
                ambientColor = Color(0xFFF4A261)
            )
            .clip(CircleShape)
            .background(
                brush = Brush.radialGradient(
                    colors = listOf(Color(0xFFF4A261), Color(0xFFE76F51))
                )
            )
            .clickable(onClick = onClick),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(text = "ðŸªœ", fontSize = 32.sp)
            Text(
                text = "æ”¾ä¸‹æ¢¯å­",
                fontSize = 14.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White
            )
        }
    }
}

/**
 * å°ç¾Šç»„ä»¶
 *
 * @param xRatio X åæ ‡ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
 * @param yRatio Y åæ ‡ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
 * @param isRescued æ˜¯å¦å·²è¢«æ•‘æ´
 * @param isNearby ç›´å‡æœºæ˜¯å¦é è¿‘
 */
@Composable
private fun Sheep(
    xRatio: Float,
    yRatio: Float,
    isRescued: Boolean,
    isNearby: Boolean,
    containerWidth: androidx.compose.ui.unit.Dp,
    containerHeight: androidx.compose.ui.unit.Dp
) {
    val scale by animateFloatAsState(
        targetValue = if (isNearby) 1.2f else 1f,
        animationSpec = spring(),
        label = "sheep_scale"
    )

    // å‘¼å¸åŠ¨ç”»ï¼ˆå½“éœ€è¦æ•‘æ´æ—¶ï¼‰
    val infiniteTransition = rememberInfiniteTransition(label = "sheep_breathe")
    val breatheScale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.05f,
        animationSpec = infiniteRepeatable(
            animation = tween(1500, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "breathe_scale"
    )

    val finalScale = if (!isRescued) scale * breatheScale else scale

    // è®¡ç®—å±å¹•ä½ç½®
    val xPos = (xRatio * containerWidth) - 40.dp
    val yPos = (yRatio * containerHeight) - 40.dp

    Box(
        modifier = Modifier
            .offset(x = xPos, y = yPos)
            .size(80.dp * finalScale)
    ) {
        // ä½¿ç”¨ Canvas ç»˜åˆ¶å¯çˆ±çš„å°ç¾Š
        Canvas(modifier = Modifier.fillMaxSize()) {
            val centerX = size.center.x
            val centerY = size.center.y
            val sheepSize = size.minDimension * 0.4f

            // èº«ä½“ï¼ˆç™½è‰²åœ†å½¢ï¼‰
            drawCircle(
                color = Color.White.copy(alpha = if (isRescued) 0.5f else 1f),
                radius = sheepSize,
                center = androidx.compose.ui.geometry.Offset(x = centerX, y = centerY + sheepSize * 0.2f)
            )

            // å¤´éƒ¨ï¼ˆç™½è‰²åœ†å½¢ï¼‰
            drawCircle(
                color = Color.White.copy(alpha = if (isRescued) 0.5f else 1f),
                radius = sheepSize * 0.6f,
                center = androidx.compose.ui.geometry.Offset(x = centerX, y = centerY - sheepSize * 0.3f)
            )

            // è€³æœµ
            drawCircle(
                color = Color.White.copy(alpha = if (isRescued) 0.5f else 1f),
                radius = sheepSize * 0.15f,
                center = androidx.compose.ui.geometry.Offset(x = centerX - sheepSize * 0.5f, y = centerY - sheepSize * 0.5f)
            )
            drawCircle(
                color = Color.White.copy(alpha = if (isRescued) 0.5f else 1f),
                radius = sheepSize * 0.15f,
                center = androidx.compose.ui.geometry.Offset(x = centerX + sheepSize * 0.5f, y = centerY - sheepSize * 0.5f)
            )

            // çœ¼ç›
            val eyeColor = if (isRescued) Color.Gray.copy(alpha = 0.3f) else Color.Black
            drawCircle(
                color = eyeColor,
                radius = sheepSize * 0.08f,
                center = androidx.compose.ui.geometry.Offset(x = centerX - sheepSize * 0.2f, y = centerY - sheepSize * 0.35f)
            )
            drawCircle(
                color = eyeColor,
                radius = sheepSize * 0.08f,
                center = androidx.compose.ui.geometry.Offset(x = centerX + sheepSize * 0.2f, y = centerY - sheepSize * 0.35f)
            )

            // é¼»å­
            drawCircle(
                color = Color(0xFFFFB6C1).copy(alpha = if (isRescued) 0.3f else 0.6f), // ç²‰è‰²
                radius = sheepSize * 0.1f,
                center = androidx.compose.ui.geometry.Offset(x = centerX, y = centerY - sheepSize * 0.22f)
            )

            // è…¿
            val legColor = Color(0xFFF0F0F0).copy(alpha = if (isRescued) 0.5f else 1f)
            drawRoundRect(
                color = legColor,
                topLeft = androidx.compose.ui.geometry.Offset(x = centerX - sheepSize * 0.6f, y = centerY + sheepSize * 0.5f),
                size = androidx.compose.ui.geometry.Size(width = sheepSize * 0.2f, height = sheepSize * 0.5f),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(4.dp.toPx())
            )
            drawRoundRect(
                color = legColor,
                topLeft = androidx.compose.ui.geometry.Offset(x = centerX + sheepSize * 0.4f, y = centerY + sheepSize * 0.5f),
                size = androidx.compose.ui.geometry.Size(width = sheepSize * 0.2f, height = sheepSize * 0.5f),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(4.dp.toPx())
            )

            // å¦‚æžœè¢«æ•‘æ´ï¼Œæ˜¾ç¤ºå‹¾é€‰æ ‡è®°
            if (isRescued) {
                drawCircle(
                    color = Color(0xFF4CAF50),
                    radius = sheepSize * 0.3f,
                    center = androidx.compose.ui.geometry.Offset(x = centerX + sheepSize * 0.8f, y = centerY - sheepSize * 0.8f),
                    style = Stroke(width = 3.dp.toPx())
                )
            }
        }

        // å½“é è¿‘æ—¶æ˜¾ç¤ºå‘å…‰æ•ˆæžœ
        if (isNearby && !isRescued) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .shadow(
                        elevation = 16.dp,
                        shape = CircleShape,
                        spotColor = Color.Yellow.copy(alpha = 0.5f)
                    )
                    .clip(CircleShape)
                    .background(Color.Transparent)
            )
        }
    }
}

/**
 * ç›´å‡æœºç»„ä»¶ï¼ˆå¯æ‹–æ‹½ï¼‰
 *
 * @param xRatio X åæ ‡ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
 * @param yRatio Y åæ ‡ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
 * @param isDragging æ˜¯å¦æ­£åœ¨æ‹–æ‹½
 */
@Composable
private fun Helicopter(
    xRatio: Float,
    yRatio: Float,
    isDragging: Boolean,
    containerWidth: androidx.compose.ui.unit.Dp,
    containerHeight: androidx.compose.ui.unit.Dp,
    onDragStarted: () -> Unit,
    onDragUpdated: (Float, Float) -> Unit,
    onDragEnded: () -> Unit
) {
    var currentPosition by remember { mutableStateOf(Offset.Zero) }

    // èžºæ—‹æ¡¨æ—‹è½¬åŠ¨ç”»
    val propellerRotation by rememberInfiniteTransition(label = "propeller").animateFloat(
        initialValue = 0f,
        targetValue = 360f,
        animationSpec = infiniteRepeatable(
            animation = tween(300, easing = LinearEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Restart
        ),
        label = "propeller_rotation"
    )

    // æ‚¬æµ®åŠ¨ç”»
    val hoverOffset by rememberInfiniteTransition(label = "hover").animateFloat(
        initialValue = 0f,
        targetValue = -10f,
        animationSpec = infiniteRepeatable(
            animation = tween(1500, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "hover_offset"
    )

    Box(
        modifier = Modifier
            .offset {
                androidx.compose.ui.unit.IntOffset(
                    x = ((xRatio * containerWidth.value - 75).dp.toPx() + currentPosition.x).toInt(),
                    y = ((yRatio * containerHeight.value - 75).dp.toPx() + currentPosition.y + hoverOffset).toInt()
                )
            }
            .size(150.dp) // â‰¥150pt ç¬¦åˆ spec è¦æ±‚
            .pointerInput(Unit) {
                detectDragGestures(
                    onDragStart = {
                        onDragStarted()
                    },
                    onDrag = { change, _ ->
                        change.consume()
                        // åº”ç”¨é€Ÿåº¦è¡°å‡ç³»æ•° 0.6ï¼ˆé™ä½Žæ“ä½œéš¾åº¦ï¼‰
                        val offsetX = (change.position.x - change.previousPosition.x) * 0.6f
                        val offsetY = (change.position.y - change.previousPosition.y) * 0.6f
                        currentPosition += Offset(offsetX, offsetY)

                        // è½¬æ¢ä¸ºå±å¹•æ¯”ä¾‹ï¼ˆä½¿ç”¨ä¸­å¿ƒç‚¹åæ ‡ï¼‰
                        // å½“å‰ä¸­å¿ƒç‚¹åƒç´ ä½ç½®
                        val currentCenterX = xRatio * containerWidth.value
                        val currentCenterY = yRatio * containerHeight.value
                        // æ–°çš„ä¸­å¿ƒç‚¹åƒç´ ä½ç½®
                        val newCenterX = currentCenterX + offsetX
                        val newCenterY = currentCenterY + offsetY
                        // è½¬æ¢ä¸ºå±å¹•æ¯”ä¾‹
                        val newXRatio = newCenterX / containerWidth.value
                        val newYRatio = newCenterY / containerHeight.value
                        onDragUpdated(newXRatio, newYRatio)
                    },
                    onDragEnd = {
                        currentPosition = Offset.Zero
                        onDragEnded()
                    }
                )
            }
            .shadow(
                elevation = if (isDragging) 20.dp else 12.dp,
                shape = RoundedCornerShape(16.dp),
                spotColor = Color(0xFFF4A261),
                ambientColor = Color(0xFFF4A261)
            )
            .clip(RoundedCornerShape(16.dp))
            .background(
                if (isDragging)
                    Color(0xFF87CEEB).copy(alpha = 0.95f) // å¤©è“è‰²ï¼ˆæ‹–æ‹½æ—¶ï¼‰
                else
                    Color(0xFF87CEEB).copy(alpha = 0.85f)  // å¤©è“è‰²
            ),
        contentAlignment = Alignment.Center
    ) {
        // ä½¿ç”¨æ›´ç®€å•çš„ç»˜åˆ¶æ–¹æ³•
        Canvas(modifier = Modifier.fillMaxSize()) {
            val centerX = size.center.x
            val centerY = size.center.y
            val helicopterSize = size.minDimension * 0.35f

            // å°¾æ¢
            drawRoundRect(
                color = Color(0xFFE63946),
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX - helicopterSize * 1.2f,
                    y = centerY - helicopterSize * 0.1f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 0.6f,
                    height = helicopterSize * 0.2f
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(4.dp.toPx())
            )

            // æœºèº«ï¼ˆæ¤­åœ†å½¢ï¼‰
            drawRoundRect(
                color = Color(0xFFE63946), // çº¢è‰²æœºèº«
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX - helicopterSize * 0.8f,
                    y = centerY - helicopterSize * 0.3f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 1.6f,
                    height = helicopterSize * 0.6f
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(helicopterSize * 0.3f)
            )

            // é©¾é©¶èˆ±ï¼ˆæ¤­åœ†ï¼‰
            drawOval(
                brush = Brush.radialGradient(
                    colors = listOf(
                        Color(0xFF87CEEB).copy(alpha = 0.9f),
                        Color(0xFF4682B4).copy(alpha = 0.7f)
                    )
                ),
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX + helicopterSize * 0.3f,
                    y = centerY - helicopterSize * 0.2f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 0.5f,
                    height = helicopterSize * 0.4f
                )
            )

            // ä¸»æ—‹ç¿¼æ†ï¼ˆæ—‹è½¬æ•ˆæžœé€šè¿‡æ”¹å˜å®½åº¦æ¨¡æ‹Ÿï¼‰
            val propellerWidth = kotlin.math.abs(kotlin.math.cos(Math.toRadians(propellerRotation.toDouble()))).toFloat() * helicopterSize * 2.4f
            drawRoundRect(
                color = Color(0xFF333333),
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX - propellerWidth / 2,
                    y = centerY - helicopterSize * 0.4f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = maxOf(propellerWidth, 4.dp.toPx()),
                    height = helicopterSize * 0.08f
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(2.dp.toPx())
            )

            // å°¾æ¡¨
            val tailPropellerHeight = kotlin.math.abs(kotlin.math.sin(Math.toRadians(propellerRotation.toDouble()))).toFloat() * helicopterSize * 0.6f
            drawRoundRect(
                color = Color(0xFF333333),
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX - helicopterSize * 1.35f,
                    y = centerY - tailPropellerHeight / 2
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 0.1f,
                    height = maxOf(tailPropellerHeight, 4.dp.toPx())
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(2.dp.toPx())
            )

            // èµ·è½æž¶
            val skidColor = Color(0xFF333333)
            // å·¦æ»‘æ©‡
            drawRoundRect(
                color = skidColor,
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX - helicopterSize * 0.4f,
                    y = centerY + helicopterSize * 0.35f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 0.8f,
                    height = helicopterSize * 0.06f
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(3.dp.toPx())
            )
            // å·¦æ”¯æž¶
            drawRoundRect(
                color = skidColor,
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX - helicopterSize * 0.35f,
                    y = centerY + helicopterSize * 0.15f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 0.04f,
                    height = helicopterSize * 0.22f
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(2.dp.toPx())
            )
            // å³æ”¯æž¶
            drawRoundRect(
                color = skidColor,
                topLeft = androidx.compose.ui.geometry.Offset(
                    x = centerX + helicopterSize * 0.31f,
                    y = centerY + helicopterSize * 0.15f
                ),
                size = androidx.compose.ui.geometry.Size(
                    width = helicopterSize * 0.04f,
                    height = helicopterSize * 0.22f
                ),
                cornerRadius = androidx.compose.ui.geometry.CornerRadius(2.dp.toPx())
            )
        }

        // æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ
        if (isDragging) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(
                        Color.White.copy(alpha = 0.2f),
                        shape = RoundedCornerShape(16.dp)
                    )
            )
        }
    }
}

/**
 * "æ”¾ä¸‹æ¢¯å­"æŒ‰é’®ï¼ˆåœ†å½¢ï¼Œâ‰¥100ptï¼‰
 *
 * @param xRatio X åæ ‡ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
 * @param yRatio Y åæ ‡ï¼ˆå±å¹•æ¯”ä¾‹ï¼‰
 */
@Composable
private fun LowerLadderButton(
    xRatio: Float,
    yRatio: Float,
    containerWidth: androidx.compose.ui.unit.Dp,
    containerHeight: androidx.compose.ui.unit.Dp,
    onClick: () -> Unit
) {
    // æŒ‰é’®è„‰å†²åŠ¨ç”»
    val infiniteTransition = rememberInfiniteTransition(label = "button_pulse")
    val pulseScale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.08f,
        animationSpec = infiniteRepeatable(
            animation = tween(800, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "pulse_scale"
    )

    Box(
        modifier = Modifier
            .offset {
                androidx.compose.ui.unit.IntOffset(
                    x = ((xRatio * containerWidth.value) - 50).dp.toPx().toInt(),
                    y = ((yRatio * containerHeight.value) + 60).dp.toPx().toInt()
                )
            }
            .size(110.dp * pulseScale) // â‰¥100pt åœ†å½¢æŒ‰é’®
            .shadow(
                elevation = 12.dp,
                shape = CircleShape,
                spotColor = Color(0xFFF4A261),
                ambientColor = Color(0xFFF4A261)
            )
            .clip(CircleShape)
            .background(
                brush = Brush.radialGradient(
                    colors = listOf(
                        Color(0xFFF4A261), // æ©™è‰²
                        Color(0xFFE76F51)  // æ·±æ©™è‰²
                    )
                )
            )
            .clickable(onClick = onClick),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            // æ¢¯å­å›¾æ ‡
            Text(
                text = "ðŸªœ",
                fontSize = 32.sp,
                modifier = Modifier.scale(pulseScale)
            )

            Spacer(modifier = Modifier.height(4.dp))

            Text(
                text = "æ”¾ä¸‹æ¢¯å­",
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White,
                textAlign = TextAlign.Center
            )
        }

        // é«˜å…‰æ•ˆæžœ
        Box(
            modifier = Modifier
                .size(40.dp)
                .offset(x = (-25).dp, y = (-25).dp)
                .background(
                    Color.White.copy(alpha = 0.15f),
                    shape = CircleShape
                )
        )
    }
}

/**
 * æ•‘æ´è§†é¢‘æ’­æ”¾è¦†ç›–å±‚
 *
 * @param sheepIndex å°ç¾Šç´¢å¼•
 * @param onPlaybackComplete æ’­æ”¾å®Œæˆå›žè°ƒ
 */
@Composable
private fun RescueVideoOverlay(
    sheepIndex: Int,
    onPlaybackComplete: (Int) -> Unit
) {
    val videoPath = "videos/rescue_sheep_${sheepIndex + 1}.mp4"

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.9f)),
        contentAlignment = Alignment.Center
    ) {
        // è§†é¢‘æ’­æ”¾å™¨
        VideoPlayer(
            videoPath = videoPath,
            modifier = Modifier
                .width(320.dp)
                .height(240.dp),
            onPlaybackCompleted = {
                onPlaybackComplete(sheepIndex)
            },
            autoPlay = true,
            showControls = false
        )
    }
}

/**
 * å¾½ç« æ”¶é›†åŠ¨ç”»è¦†ç›–å±‚ï¼ˆå«åº†ç¥åŠ¨ç”»ï¼‰
 *
 * @param show æ˜¯å¦æ˜¾ç¤º
 * @param sheepIndex èŽ·å¾—å¾½ç« çš„å°ç¾Šç´¢å¼•
 * @param onAnimationComplete åŠ¨ç”»å®Œæˆå›žè°ƒ
 */
@Composable
private fun BadgeAnimationOverlay(
    show: Boolean,
    sheepIndex: Int?,
    onAnimationComplete: () -> Unit
) {
    AnimatedVisibility(
        visible = show,
        enter = scaleIn(animationSpec = spring(dampingRatio = 0.6f)) + fadeIn(),
        exit = scaleOut() + fadeOut()
    ) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(Color.Black.copy(alpha = 0.75f)),
            contentAlignment = Alignment.Center
        ) {
            // åº†ç¥åŠ¨ç”»æ•ˆæžœï¼ˆçƒŸèŠ±ç²’å­ï¼‰
            val infiniteTransition = rememberInfiniteTransition(label = "celebration")
            val particleRotation by infiniteTransition.animateFloat(
                initialValue = 0f,
                targetValue = 360f,
                animationSpec = infiniteRepeatable(
                    animation = tween(10000, easing = LinearEasing),
                    repeatMode = androidx.compose.animation.core.RepeatMode.Restart
                ),
                label = "particle_rotation"
            )

            // çƒŸèŠ±ç²’å­èƒŒæ™¯
            Canvas(modifier = Modifier.fillMaxSize()) {
                val centerX = size.center.x
                val centerY = size.center.y
                val colors = listOf(
                    Color(0xFFFFD700), // é‡‘è‰²
                    Color(0xFFFF6B6B), // çº¢è‰²
                    Color(0xFF4ECDC4), // é’è‰²
                    Color(0xFFFFA07A), // æ©™è‰²
                    Color(0xFF98D8C8), // è–„è·ç»¿
                    Color(0xFFF7DC6F), // é»„è‰²
                )

                // ç»˜åˆ¶çƒŸèŠ±ç²’å­
                repeat(12) { i ->
                    val angle = Math.toRadians((particleRotation + i * 30f).toDouble())
                    val distance = 200f + kotlin.math.sin(Math.toRadians((particleRotation * 2 + i * 45f).toDouble())).toFloat() * 50f
                    val x = centerX + kotlin.math.cos(angle).toFloat() * distance
                    val y = centerY + kotlin.math.sin(angle).toFloat() * distance
                    val color = colors[i % colors.size]

                    // ç²’å­è½¨è¿¹
                    drawCircle(
                        color = color.copy(alpha = 0.6f),
                        radius = 8.dp.toPx() * (1 + kotlin.math.sin(Math.toRadians((particleRotation * 3).toDouble())).toFloat() * 0.3f),
                        center = androidx.compose.ui.geometry.Offset(x = x, y = y)
                    )

                    // æ˜Ÿæ˜Ÿé—ªçƒ
                    val starAngle = Math.toRadians((particleRotation * 1.5f + i * 60f).toDouble())
                    val starX = centerX + kotlin.math.cos(starAngle).toFloat() * (distance + 80f)
                    val starY = centerY + kotlin.math.sin(starAngle).toFloat() * (distance + 80f)
                    drawCircle(
                        color = Color.Yellow.copy(alpha = 0.8f),
                        radius = 4.dp.toPx(),
                        center = androidx.compose.ui.geometry.Offset(x = starX, y = starY)
                    )
                }
            }

            Column(
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // å¾½ç« æ—‹è½¬ç¼©æ”¾åŠ¨ç”»
                val badgeScale by rememberInfiniteTransition(label = "badge_scale").animateFloat(
                    initialValue = 1f,
                    targetValue = 1.1f,
                    animationSpec = infiniteRepeatable(
                        animation = tween(600, easing = FastOutSlowInEasing),
                        repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
                    ),
                    label = "badge_scale"
                )

                // å°ç¾Šå›¾æ ‡ï¼ˆæµ®åŠ¨åŠ¨ç”»ï¼‰
                val sheepFloat by rememberInfiniteTransition(label = "sheep_float").animateFloat(
                    initialValue = 0f,
                    targetValue = -10f,
                    animationSpec = infiniteRepeatable(
                        animation = tween(1000, easing = FastOutSlowInEasing),
                        repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
                    ),
                    label = "sheep_float"
                )

                // å°ç¾Š
                Box(modifier = Modifier.offset(y = sheepFloat.dp)) {
                    Text(
                        text = "ðŸ‘",
                        fontSize = 80.sp,
                        modifier = Modifier.shadow(
                            elevation = 8.dp,
                            shape = CircleShape,
                            spotColor = Color.Yellow
                        )
                    )
                }

                Spacer(modifier = Modifier.height(16.dp))

                // å¾½ç« 
                Box(modifier = Modifier.scale(badgeScale)) {
                    Text(
                        text = "ðŸ…",
                        fontSize = 100.sp,
                        modifier = Modifier.shadow(
                            elevation = 16.dp,
                            shape = CircleShape,
                            ambientColor = Color(0xFFF4A261),
                            spotColor = Color(0xFFF4A261)
                        )
                    )
                }

                Spacer(modifier = Modifier.height(32.dp))

                // èµžç¾Žæ–‡å­—ï¼ˆé€ä¸ªå‡ºçŽ°åŠ¨ç”»ï¼‰
                Text(
                    text = "ä½ çœŸæ£’ï¼",
                    fontSize = 40.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color.White,
                    modifier = Modifier.shadow(8.dp, CircleShape, ambientColor = Color.Yellow, spotColor = Color.Yellow)
                )

                Spacer(modifier = Modifier.height(16.dp))

                Text(
                    text = "æˆåŠŸæ•‘å‡ºç¬¬ ${sheepIndex?.plus(1)} åªå°ç¾Šï¼",
                    fontSize = 24.sp,
                    fontWeight = FontWeight.Medium,
                    color = Color.Yellow
                )

                Spacer(modifier = Modifier.height(48.dp))

                // ç‚¹å‡»ç»§ç»­æŒ‰é’®
                Box(
                    modifier = Modifier
                        .shadow(
                            elevation = 12.dp,
                            shape = CircleShape,
                            spotColor = Color(0xFF2A9D8F)
                        )
                        .background(
                            Color(0xFF2A9D8F),
                            shape = androidx.compose.foundation.shape.RoundedCornerShape(28.dp)
                        )
                        .padding(horizontal = 40.dp, vertical = 16.dp)
                        .clickable(onClick = onAnimationComplete)
                ) {
                    Text(
                        text = "ç‚¹å‡»ç»§ç»­ â–¶",
                        fontSize = 22.sp,
                        fontWeight = FontWeight.Bold,
                        color = Color.White
                    )
                }
            }
        }
    }
}

/**
 * æ£®æž—ç«ç¾èƒŒæ™¯ç»„ä»¶
 *
 * ä½¿ç”¨æ¸å˜å’ŒåŠ¨ç”»æ•ˆæžœæ¨¡æ‹Ÿæ£®æž—ç«ç¾åœºæ™¯
 */
@Composable
private fun ForestFireBackground() {
    val infiniteTransition = rememberInfiniteTransition(label = "fire_animation")

    // çƒŸé›¾é£˜åŠ¨åŠ¨ç”»
    val smokeOffset by infiniteTransition.animateFloat(
        initialValue = 0f,
        targetValue = 100f,
        animationSpec = infiniteRepeatable(
            animation = tween(8000, easing = LinearEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Restart
        ),
        label = "smoke_offset"
    )

    // ç«ç„°é—ªçƒåŠ¨ç”»
    val fireAlpha by infiniteTransition.animateFloat(
        initialValue = 0.3f,
        targetValue = 0.5f,
        animationSpec = infiniteRepeatable(
            animation = tween(1000, easing = FastOutSlowInEasing),
            repeatMode = androidx.compose.animation.core.RepeatMode.Reverse
        ),
        label = "fire_alpha"
    )

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(
                brush = Brush.verticalGradient(
                    colors = listOf(
                        Color(0xFF1a3a2a), // æ·±ç»¿
                        Color(0xFF2A4D3F), // æ£®æž—ç»¿
                        Color(0xFF3D5A50), // ä¸­ç»¿
                        Color(0xFF2A4D3F), // æ£®æž—ç»¿
                        Color(0xFF1a3a2a), // æ·±ç»¿
                    )
                )
            )
    ) {
        // ç»˜åˆ¶ç«ç„°æ•ˆæžœï¼ˆåœ¨åº•éƒ¨ï¼‰
        Canvas(modifier = Modifier.fillMaxSize()) {
            val canvasWidth = size.width
            val canvasHeight = size.height

            // ç»˜åˆ¶å¤šå±‚ç«ç„°æ¸å˜
            val fireColors = listOf(
                Color(0xFFFF6B35).copy(alpha = fireAlpha), // æ©™çº¢
                Color(0xFFF7931E).copy(alpha = fireAlpha * 0.8f), // æ©™è‰²
                Color(0xFFFFCC00).copy(alpha = fireAlpha * 0.6f), // é»„è‰²
            )

            // ç«ç„°ä»Žåº•éƒ¨å‡èµ·
            val flameHeight = canvasHeight * 0.3f
            val flameBaseY = canvasHeight

            fireColors.forEachIndexed { index, color ->
                drawRoundRect(
                    color = color,
                    topLeft = androidx.compose.ui.geometry.Offset(
                        x = 0f,
                        y = flameBaseY - flameHeight - (smokeOffset % 50f) - (index * 20f)
                    ),
                    size = androidx.compose.ui.geometry.Size(
                        width = canvasWidth,
                        height = flameHeight + (index * 30f)
                    ),
                    cornerRadius = androidx.compose.ui.geometry.CornerRadius(
                        x = 100f,
                        y = 100f
                    )
                )
            }

            // ç»˜åˆ¶çƒŸé›¾ç²’å­
            val smokeCount = 8
            val smokeRadius = 60f
            repeat(smokeCount) { index ->
                val angle = (index.toFloat() / smokeCount) * 2 * kotlin.math.PI.toFloat()
                val smokeX = canvasWidth * 0.5f + kotlin.math.sin(angle + smokeOffset * 0.01f) * canvasWidth * 0.3f
                val smokeY = canvasHeight * 0.7f + kotlin.math.sin(angle * 2 + smokeOffset * 0.02f) * 100f - (smokeOffset % 200f)

                drawCircle(
                    color = Color.White.copy(alpha = 0.05f),
                    radius = smokeRadius * (1 + (index % 3) * 0.3f),
                    center = androidx.compose.ui.geometry.Offset(x = smokeX, y = smokeY)
                )
            }
        }

        // ç»˜åˆ¶æ ‘æœ¨è½®å»“ï¼ˆèƒŒæ™¯å±‚ï¼‰
        Canvas(modifier = Modifier.fillMaxSize()) {
            val canvasWidth = size.width
            val canvasHeight = size.height

            // ç®€å•çš„æ ‘æœ¨å½¢çŠ¶
            val treeColor = Color(0xFF1a3a2a).copy(alpha = 0.5f)
            val treePositions = listOf(0.1f, 0.25f, 0.4f, 0.6f, 0.75f, 0.9f)

            treePositions.forEach { xPos ->
                val x = canvasWidth * xPos
                val treeHeight = canvasHeight * 0.25f
                val treeWidth = canvasHeight * 0.08f

                // æ ‘å¹²
                drawRoundRect(
                    color = Color(0xFF3d2817).copy(alpha = 0.4f),
                    topLeft = androidx.compose.ui.geometry.Offset(
                        x = x - treeWidth * 0.15f,
                        y = canvasHeight - treeHeight * 0.4f
                    ),
                    size = androidx.compose.ui.geometry.Size(
                        width = treeWidth * 0.3f,
                        height = treeHeight * 0.4f
                    ),
                    cornerRadius = androidx.compose.ui.geometry.CornerRadius(4.dp.toPx())
                )

                // æ ‘å† ï¼ˆä¸‰è§’å½¢ï¼‰
                val path = androidx.compose.ui.graphics.Path().apply {
                    moveTo(x, canvasHeight - treeHeight * 1.2f)
                    lineTo(x - treeWidth * 0.5f, canvasHeight - treeHeight * 0.4f)
                    lineTo(x + treeWidth * 0.5f, canvasHeight - treeHeight * 0.4f)
                    close()
                }

                drawPath(
                    path = path,
                    color = treeColor,
                    style = Stroke(width = 3.dp.toPx())
                )
            }
        }
    }
}
